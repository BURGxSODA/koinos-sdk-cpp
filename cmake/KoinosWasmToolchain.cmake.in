message(STATUS "Setting up Koinos Wasm Toolchain @VERSION_FULL@")

set(CMAKE_SYSTEM_NAME Generic)
set(CMAKE_SYSTEM_PROCESSOR wasm)

set(KOINOS_WASI_SDK_ROOT $ENV{KOINOS_WASI_SDK_ROOT})
set(KOINOS_CDT_ROOT $ENV{KOINOS_CDT_ROOT})

if(WIN32)
  set(KOINOS_WASI_HOST_EXE_SUFFIX ".exe")
else()
  set(KOINOS_WASI_HOST_EXE_SUFFIX "")
endif()

set(CMAKE_C_COMPILER ${KOINOS_WASI_SDK_ROOT}/bin/clang${KOINOS_WASI_HOST_EXE_SUFFIX})
set(CMAKE_C_COMPILER_TARGET wasm32-wasi)

set(CMAKE_CXX_COMPILER ${KOINOS_WASI_SDK_ROOT}/bin/clang++${KOINOS_WASI_HOST_EXE_SUFFIX})
set(CMAKE_CXX_COMPILER_TARGET wasm32-wasi)

set(CMAKE_ASM_COMPILER ${KOINOS_WASI_SDK_ROOT}/bin/clang${KOINOS_WASI_HOST_EXE_SUFFIX})

set(CMAKE_AR ${KOINOS_WASI_SDK_ROOT}/bin/llvm-ar${KOINOS_WASI_HOST_EXE_SUFFIX})
set(CMAKE_RANLIB ${KOINOS_WASI_SDK_ROOT}/bin/llvm-ranlib${KOINOS_WASI_HOST_EXE_SUFFIX})
set(CMAKE_LINKER ${KOINOS_WASI_SDK_ROOT}/bin/wasm-ld${KOINOS_WASI_HOST_EXE_SUFFIX})

set(CMAKE_SYSROOT ${KOINOS_WASI_SDK_ROOT}/share/wasi-sysroot)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_CXX_FLAGS_RELEASE "-DNDEBUG -Os")

add_compile_options(
  -I${KOINOS_WASI_SDK_ROOT}/share/wasi-sysroot/include
  -I${KOINOS_WASI_SDK_ROOT}/share/wasi-sysroot/include/c++/v1
  -I${KOINOS_CDT_ROOT}/include)

add_link_options(
  --no-entry
  --allow-undefined
  -L${KOINOS_WASI_SDK_ROOT}/share/wasi-sysroot/lib/wasm32-wasi
  -L${KOINOS_CDT_ROOT}/lib)

set(CMAKE_C_LINK_EXECUTABLE "<CMAKE_LINKER> <LINK_FLAGS> <OBJECTS> -o <TARGET> <LINK_LIBRARIES>")
set(CMAKE_CXX_LINK_EXECUTABLE "<CMAKE_LINKER> <LINK_FLAGS> <OBJECTS> -o <TARGET> <LINK_LIBRARIES>")

set(CMAKE_EXECUTABLE_SUFFIX_C ".wasm")
set(CMAKE_EXECUTABLE_SUFFIX_CXX ".wasm")

set(CMAKE_FIND_ROOT_PATH ${KOINOS_CDT_ROOT})
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
